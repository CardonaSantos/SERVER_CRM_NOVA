/// ======================================================================
/// CONFIGURACIÓN PRISMA
/// ======================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_CRM")
}
// comentario nuevo

/// ======================================================================
/// ÍNDICE DE SECCIONES (BUSCAR POR TAG EN VS CODE)
///
/// [01] Empresa, Usuarios, Caja y Proveedores
/// [02] Geografía
/// [03] Facturación - Configuración y Plantillas
/// [04] Servicios
/// [05] Clientes Internet y Relacionados
/// [06] Media y Álbumes
/// [07] Facturación - Operaciones
/// [08] Rutas de Cobro
/// [09] Soporte y Tickets
/// [10] Asistencia / RRHH
/// [11] Modelos de Prueba
/// [12] Enumeraciones
/// ======================================================================

/// [01] Empresa, Usuarios, Caja y Proveedores
model Empresa {
  id                  Int                   @id @default(autoincrement())
  nombre              String                @unique
  direccion           String?
  telefono            String?
  pbx                 String?
  correo              String?
  sitioWeb            String?
  nit                 String?
  logo1               String?
  logo2               String?
  logo3               String?
  creadoEn            DateTime              @default(now())
  actualizadoEn       DateTime              @updatedAt
  albumClientes       AlbumCliente[]
  clientesInternet    ClienteInternet[]
  ConfiguracionGlobal ConfiguracionGlobal[]
  Factura             Factura[]
  facturas            FacturaInternet[]
  FacturacionZona     FacturacionZona[]
  medias              Media[]
  plantillas          PlantillaMensaje[]
  Proveedor           Proveedor[]
  rutas               Ruta[]
  saldoCaja           SaldoCaja?
  saldoEmpresa        SaldoEmpresa?
  Servicio            Servicio[]
  ServicioInternet    ServicioInternet[]
  TicketSoporte       TicketSoporte[]
  Ubicacion           Ubicacion[]
  empleados           Usuario[]
  notificaciones      Notificacion[]

  //nuevos
  Olt            Olt[]
  MikrotikRouter MikrotikRouter[]
}

model Usuario {
  id                     Int                    @id @default(autoincrement())
  empresaId              Int
  nombre                 String
  correo                 String                 @unique
  telefono               String?
  rol                    RolUsuario
  activo                 Boolean                @default(true)
  creadoEn               DateTime               @default(now())
  actualizadoEn          DateTime               @updatedAt
  contrasena             String
  perfil                 PerfilUsuario?
  asistencias            Asistencia[]           @relation("UsuarioAsistencias")
  BoletaSoporte          BoletaSoporte[]
  clientesAsesorados     ClienteInternet[]
  facturasEliminadas     FacturaEliminada[]
  facturasCreadas        FacturaInternet[]      @relation("FacturaInternetCreador")
  facturasAsignadas      FacturaRuta[]          @relation("AsignadorFacturaRuta")
  facturasCobradas       FacturaRuta[]          @relation("CobradorFacturaRuta")
  archivosCargados       Media[]
  metasTecnico           MetaTecnicoTicket[]    @relation("MetaTecnicoRelation")
  MetaTickets            MetaTickets[]
  PagoFacturaInternet    PagoFacturaInternet[]
  RegistroCaja           RegistroCaja[]
  Ruta                   Ruta[]
  rutaTurnosComoCobrador RutaTurno[]
  SeguimientoTicket      SeguimientoTicket[]
  ticketsCreados         TicketSoporte[]        @relation("TicketCreador")
  ticketsAsignados       TicketSoporte[]        @relation("TicketTecnico")
  ticketsSoporteTecnico  TicketSoporteTecnico[]
  empresa                Empresa                @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  clientesEliminados     ClienteInternet[]      @relation("ClienteEliminadoPor")

  notificacionesRecibidas NotificacionUsuario[]
  notificacionesEnviadas  Notificacion[]        @relation("NotificacionRemitente")
  logsTiempo       TicketTimeLog[] @relation("LogTecnico")
}

model PerfilUsuario {
  id        Int @id @default(autoincrement())
  usuarioId Int @unique

  // Visual
  avatarUrl String? // URL de la foto de perfil (cdn, media, etc.)
  portada   String? // URL de la foto de perfil (cdn, media, etc.)
  bio       String?
  // Preferencias básicas
  // tema            TemaUsuario @default(SISTEMA) aun no implementado

  // Notificaciones
  notificarWhatsApp Boolean @default(true)
  notificarPush     Boolean @default(true) // para notificaciones in-app
  notificarSonido   Boolean @default(true) // sonidos en la UI

  telefono String?

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model ConfiguracionGlobal {
  id            Int      @id @default(autoincrement())
  empresaId     Int
  clave         String   @unique
  valor         String
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  empresa       Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

model SaldoEmpresa {
  id            Int      @id @default(autoincrement())
  saldo         Float    @default(0)
  egresos       Float    @default(0)
  totalIngresos Float
  empresaId     Int      @unique
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  empresa       Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

model SaldoCaja {
  id            Int            @id @default(autoincrement())
  saldo         Float          @default(0)
  egreso        Float          @default(0)
  totalIngresos Float
  totalEgresos  Float
  empresaId     Int            @unique
  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt
  registrosCaja RegistroCaja[]
  empresa       Empresa        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

model RegistroCaja {
  id            Int        @id @default(autoincrement())
  saldoInicial  Float
  saldoFinal    Float
  usuarioId     Int?
  cajaId        Int?
  creadoEn      DateTime   @default(now())
  actualizadoEn DateTime   @updatedAt
  caja          SaldoCaja? @relation(fields: [cajaId], references: [id])
  usuario       Usuario?   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model Proveedor {
  id        Int     @id @default(autoincrement())
  nombre    String
  correo    String?
  telefono  String?
  direccion String?
  empresaId Int
  empresa   Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

/// [02] Geografía
model Departamento {
  id         Int               @id @default(autoincrement())
  nombre     String            @unique
  clientes   ClienteInternet[]
  municipios Municipio[]
}

model Municipio {
  id             Int               @id @default(autoincrement())
  nombre         String            @unique
  departamentoId Int
  clientes       ClienteInternet[]
  departamento   Departamento      @relation(fields: [departamentoId], references: [id], onDelete: Cascade)
  Sector         Sector[]
}

model Sector {
  id            Int               @id @default(autoincrement())
  nombre        String
  descripcion   String?
  municipioId   Int
  creadoEn      DateTime          @default(now())
  actualizadoEn DateTime          @updatedAt
  clientes      ClienteInternet[]
  municipio     Municipio         @relation(fields: [municipioId], references: [id], onDelete: Cascade)
}

model Ubicacion {
  id        Int              @id @default(autoincrement())
  creadoEn  DateTime         @default(now())
  latitud   Float?
  longitud  Float?
  clienteId Int?             @unique
  empresaId Int
  cliente   ClienteInternet? @relation(fields: [clienteId], references: [id])
  empresa   Empresa          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

/// [03] Facturación - Configuración y Plantillas
model FacturacionZona {
  id                            Int               @id @default(autoincrement())
  nombre                        String
  empresaId                     Int
  diaGeneracionFactura          Int
  diaPago                       Int
  diaRecordatorio               Int?
  horaRecordatorio              String?
  enviarRecordatorio            Boolean           @default(true)
  diaCorte                      Int?
  suspenderTrasFacturas         Int?
  creadoEn                      DateTime          @default(now())
  actualizadoEn                 DateTime          @updatedAt
  diaSegundoRecordatorio        Int?
  email                         Boolean           @default(false)
  llamada                       Boolean           @default(false)
  sms                           Boolean           @default(false)
  telegram                      Boolean           @default(true)
  whatsapp                      Boolean           @default(true)
  enviarAvisoPago               Boolean           @default(true)
  enviarRecordatorio1           Boolean           @default(true)
  enviarRecordatorio2           Boolean           @default(true)
  enviarRecordatorioGeneracion  Boolean           @default(true)
  enviarSiTieneFacturasVencidas Boolean           @default(false)
  clientes                      ClienteInternet[]
  facturas                      FacturaInternet[]
  empresa                       Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

model PlantillaMensaje {
  id            Int           @id @default(autoincrement())
  nombre        String
  tipo          TipoPlantilla
  body          String
  empresaId     Int
  creadoEn      DateTime      @default(now())
  actualizadoEn DateTime      @updatedAt
  empresa       Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

model PlantillaContrato {
  id            Int      @id @default(autoincrement())
  nombre        String
  body          String
  empresaId     Int
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
}

/// [04] Servicios
model TipoServicio {
  id            Int            @id @default(autoincrement())
  nombre        String         @unique
  descripcion   String?
  estado        EstadoServicio @default(ACTIVO)
  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt
  servicios     Servicio[]
}

model Servicio {
  id              Int               @id @default(autoincrement())
  nombre          String
  descripcion     String?
  precio          Float
  estado          EstadoServicio    @default(ACTIVO)
  tipoServicioId  Int?
  empresaId       Int
  creadoEn        DateTime          @default(now())
  actualizadoEn   DateTime          @updatedAt
  clientes        ClienteServicio[]
  FacturaServicio FacturaServicio[]
  empresa         Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  tipoServicio    TipoServicio?     @relation(fields: [tipoServicioId], references: [id], onDelete: Restrict)
}

model ServicioInternet {
  id            Int               @id @default(autoincrement())
  nombre        String
  velocidad     String?
  precio        Float
  estado        EstadoServicio    @default(ACTIVO)
  creadoEn      DateTime          @default(now())
  actualizadoEn DateTime          @updatedAt
  empresaId     Int
  clientes      ClienteInternet[]
  empresa       Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

/// [05] Clientes Internet y Relacionados
model ClienteInternet {
  // Identidad
  id                         Int                       @id @default(autoincrement())
  empresaId                  Int?
  asesorId                   Int?
  // Información personal
  nombre                     String
  apellidos                  String?
  dpi                        String?
  observaciones              String?
  nota                       String?
  // Información de contacto
  telefono                   String?
  direccion                  String?
  contactoReferenciaNombre   String?
  contactoReferenciaTelefono String?
  // Servicio y red
  contrasenaWifi             String?
  ssidRouter                 String?
  fechaInstalacion           DateTime?
  servicioInternetId         Int?
  sectorId                   Int?
  // Opciones y flags
  enviarRecordatorio         Boolean                   @default(true)
  isEliminado                Boolean                   @default(false)
  eliminadoEn                DateTime?
  // ESTADO DE SERVICIO-CLIENTE Y COBRANZA =>
  estadoCliente              EstadoCliente
  estadoCobranza             EstadoCobranzaCliente     @default(AL_DIA)
  // Geografía
  municipioId                Int?
  departamentoId             Int?
  facturacionZonaId          Int?
  //Optico
  mikrotikRouterId           Int?
  MikrotikRouter             MikrotikRouter?           @relation(fields: [mikrotikRouterId], references: [id])
  estadoServicioMikrotik     EstadoServicioMikrotik @default(SIN_MIKROTIK)

  //BUSQUEDA
  searchNombre              String?
  // Metadatos
  creadoEn                   DateTime                  @default(now())
  actualizadoEn              DateTime                  @updatedAt
  desinstaladoEn             DateTime?

  // Relaciones principales
  empresa                    Empresa?                  @relation(fields: [empresaId], references: [id])
  asesor                     Usuario?                  @relation(fields: [asesorId], references: [id])
  departamento               Departamento?             @relation(fields: [departamentoId], references: [id])
  municipio                  Municipio?                @relation(fields: [municipioId], references: [id])
  facturacionZona            FacturacionZona?          @relation(fields: [facturacionZonaId], references: [id])
  sector                     Sector?                   @relation(fields: [sectorId], references: [id])
  servicioInternet           ServicioInternet?         @relation(fields: [servicioInternetId], references: [id])
  // Relaciones de datos / hijos
  albumClientes              AlbumCliente[]
  clienteServicios           ClienteServicio[]
  CobroRuta                  CobroRuta[]
  ContratoFisico             ContratoFisico?
  ContratoServicioInternet   ContratoServicioInternet? @relation("ContratoCliente")
  factura                    Factura[]
  facturaInternet            FacturaInternet[]
  fotos                      Fotos[]
  IP                         IP?
  Lead                       Lead[]
  medias                     Media[]
  pagoFactura                PagoFactura[]
  PagoFacturaInternet        PagoFacturaInternet[]
  RecordatorioPago           RecordatorioPago[]
  ticketSoporte              TicketSoporte[]
  ubicacion                  Ubicacion?
  saldoCliente               saldoCliente?
  ruta                       Ruta[]                    @relation("ClienteInternetToRuta")
  eliminadoPorId             Int?
  eliminadoPor               Usuario?                  @relation("ClienteEliminadoPor", fields: [eliminadoPorId], references: [id], onDelete: SetNull)
  
}

model IP {
  id          Int              @id @default(autoincrement())
  direccionIp String?          @default("192.168.1.1")
  clienteId   Int?             @unique
  gateway     String?          @default("192.168.1.1")
  mascara     String?          @default("255.255.255.0")
  cliente     ClienteInternet? @relation(fields: [clienteId], references: [id], onDelete: Cascade)
}

model Fotos {
  id            Int             @id @default(autoincrement())
  nombreFoto    String
  url           String?
  clienteId     Int
  creadoEn      DateTime        @default(now())
  actualizadoEn DateTime        @updatedAt
  cliente       ClienteInternet @relation(fields: [clienteId], references: [id], onDelete: Cascade)
}

model saldoCliente {
  id             Int             @id @default(autoincrement())
  saldoPendiente Float?          @default(0)
  saldoFavor     Float?          @default(0)
  totalPagos     Float?          @default(0)
  clienteId      Int             @unique
  creadoEn       DateTime        @default(now())
  actualizadoEn  DateTime        @updatedAt
  ultimoPago     DateTime?
  cliente        ClienteInternet @relation(fields: [clienteId], references: [id], onDelete: Cascade)
}

model ContratoFisico {
  id              Int              @id @default(autoincrement())
  clienteId       Int?             @unique
  idContrato      String           @unique
  fechaFirma      DateTime?        @default(now())
  archivoContrato String?
  creadoEn        DateTime?        @default(now())
  actualizadoEn   DateTime         @updatedAt
  observaciones   String?
  comentario      String?
  mediaId         Int?
  cliente         ClienteInternet? @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  media           Media?           @relation(fields: [mediaId], references: [id])
}

model ContratoServicioInternet {
  id                         Int             @id @default(autoincrement())
  clienteId                  Int             @unique
  fechaInstalacionProgramada DateTime?
  costoInstalacion           Float?
  fechaPago                  DateTime?
  observaciones              String?
  creadoEn                   DateTime        @default(now())
  actualizadoEn              DateTime        @updatedAt
  cliente                    ClienteInternet @relation("ContratoCliente", fields: [clienteId], references: [id], onDelete: Cascade)
}

model ClienteServicio {
  id            Int                   @id @default(autoincrement())
  clienteId     Int
  servicioId    Int
  fechaInicio   DateTime              @default(now())
  fechaFin      DateTime?
  estado        EstadoClienteServicio @default(ACTIVO)
  creadoEn      DateTime              @default(now())
  actualizadoEn DateTime              @updatedAt
  cliente       ClienteInternet       @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  servicio      Servicio              @relation(fields: [servicioId], references: [id], onDelete: Cascade)
}

model Lead {
  id        Int              @id @default(autoincrement())
  nombre    String
  correo    String?
  telefono  String?
  fuente    String
  estado    String
  creadoEn  DateTime         @default(now())
  clienteId Int?
  cliente   ClienteInternet? @relation(fields: [clienteId], references: [id])
}

/// [06] Media y Álbumes
/// /////////////////////////////////////////////////////////////////////////////
/// /////////////////////////////////////////////////////////////////////////////
model Media {
  id              Int              @id @default(autoincrement())
  empresaId       Int
  clienteId       Int?
  albumId         Int?
  subidoPorId     Int?
  categoria       CategoriaMedia   @default(CLIENTE_GENERAL)
  tipo            TipoMedia
  estado          EstadoMedia      @default(PENDIENTE)
  bucket          String?
  region          String?
  key             String
  cdnUrl          String?
  mimeType        String?
  extension       String?
  tamanioBytes    BigInt?
  ancho           Int?
  alto            Int?
  duracionSeg     Int?
  checksumSha256  String?          @db.VarChar(64)
  titulo          String?
  descripcion     String?
  etiqueta        String?
  orden           Int              @default(0)
  tomadoEn        DateTime?
  publico         Boolean          @default(false)
  eliminadoEn     DateTime?
  metadatos       Json?
  creadoEn        DateTime         @default(now())
  actualizadoEn   DateTime         @updatedAt
  notas           String?
  portadaDe       AlbumCliente[]   @relation("PortadaAlbum")
  contratoFisicos ContratoFisico[]
  album           AlbumCliente?    @relation("AlbumMedias", fields: [albumId], references: [id])
  cliente         ClienteInternet? @relation(fields: [clienteId], references: [id])
  empresa         Empresa          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  subidoPor       Usuario?         @relation(fields: [subidoPorId], references: [id])

  @@unique([bucket, key])
  @@index([clienteId, albumId, creadoEn(sort: Desc)])
  @@index([empresaId, categoria, tipo])
}

model AlbumCliente {
  id            Int             @id @default(autoincrement())
  empresaId     Int
  clienteId     Int
  nombre        String
  descripcion   String?
  portadaId     Int?
  esGeneral     Boolean         @default(false)
  creadoEn      DateTime        @default(now())
  actualizadoEn DateTime        @updatedAt
  orden         Int?
  cliente       ClienteInternet @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  empresa       Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  portadaDe     Media?          @relation("PortadaAlbum", fields: [portadaId], references: [id])
  medias        Media[]         @relation("AlbumMedias")

  @@unique([clienteId, nombre])
  @@index([clienteId, creadoEn(sort: Desc)])
}

/// [07] Facturación - Operaciones
model FacturaInternet {
  id                    Int                   @id @default(autoincrement())
  fechaPagoEsperada     DateTime?
  fechaPagada           DateTime?
  montoPago             Float?
  saldoPendiente        Float?                @default(0)
  empresaId             Int
  clienteId             Int
  creadoEn              DateTime              @default(now())
  actualizadoEn         DateTime              @updatedAt
  detalleFactura        String?
  nombreClienteFactura  String?
  facturacionZonaId     Int?
  estadoFacturaInternet StateFacturaInternet  @default(PENDIENTE)
  creadorId             Int?
  periodo               String                @db.VarChar(6)
  serviciosAdicionales  Factura[]             @relation("ServiciosPorInternet")
  facturasEliminadas    FacturaEliminada[]
  cliente               ClienteInternet       @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  creador               Usuario?              @relation("FacturaInternetCreador", fields: [creadorId], references: [id])
  empresa               Empresa               @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  facturacionZona       FacturacionZona?      @relation(fields: [facturacionZonaId], references: [id])
  rutasAsignadas        FacturaRuta[]
  pagos                 PagoFacturaInternet[]
  RecordatorioPago      RecordatorioPago[]

  @@unique([clienteId, facturacionZonaId, periodo])
}

model Factura {
  id                Int               @id @default(autoincrement())
  empresaId         Int
  clienteId         Int
  tipoFactura       TipoFactura
  montoTotal        Float
  saldoPendiente    Float             @default(0)
  fechaEmision      DateTime          @default(now())
  fechaVencimiento  DateTime?
  estado            EstadoFactura     @default(PENDIENTE)
  creadoEn          DateTime          @default(now())
  actualizadoEn     DateTime          @updatedAt
  facturaInternetId Int?
  cliente           ClienteInternet   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  empresa           Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  facturaInternet   FacturaInternet?  @relation("ServiciosPorInternet", fields: [facturaInternetId], references: [id])
  servicios         FacturaServicio[]
  pagos             PagoFactura[]
}

model FacturaServicio {
  id             Int      @id @default(autoincrement())
  facturaId      Int
  servicioId     Int
  cantidad       Int      @default(1)
  precioUnitario Float
  total          Float
  creadoEn       DateTime @default(now())
  actualizadoEn  DateTime @updatedAt
  factura        Factura  @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  servicio       Servicio @relation(fields: [servicioId], references: [id], onDelete: Cascade)
}

model PagoFacturaInternet {
  id                 Int                       @id @default(autoincrement())
  facturaInternetId  Int
  clienteId          Int
  montoPagado        Float
  metodoPago         MetodoPagoFacturaInternet
  fechaPago          DateTime                  @default(now())
  creadoEn           DateTime                  @default(now())
  cobradorId         Int?
  numeroBoleta       String?                   @unique
  codigoConfirmacion String?                   @unique
  facturaRutaId      Int?
  origen             OrigenPago                @default(RUTA)
  cliente            ClienteInternet           @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  cobrador           Usuario?                  @relation(fields: [cobradorId], references: [id])
  facturaInternet    FacturaInternet           @relation(fields: [facturaInternetId], references: [id], onDelete: Cascade)
  facturaRuta        FacturaRuta?              @relation(fields: [facturaRutaId], references: [id])

  @@index([facturaRutaId])
  @@index([facturaInternetId, fechaPago])
}

model PagoFactura {
  id          Int             @id @default(autoincrement())
  facturaId   Int
  clienteId   Int
  montoPagado Float
  metodoPago  MetodoPago
  fechaPago   DateTime        @default(now())
  creadoEn    DateTime        @default(now())
  cliente     ClienteInternet @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  factura     Factura         @relation(fields: [facturaId], references: [id], onDelete: Cascade)
}

model RecordatorioPago {
  id                Int                       @id @default(autoincrement())
  clienteId         Int
  facturaInternetId Int
  tipo              String
  mensaje           String
  fechaEnviado      DateTime
  creadoEn          DateTime                  @default(now())
  actualizadoEn     DateTime                  @updatedAt
  resultado         ResultadoRecordatorioPago
  cliente           ClienteInternet           @relation(fields: [clienteId], references: [id])
  facturaInternet   FacturaInternet           @relation(fields: [facturaInternetId], references: [id], onDelete: Cascade)
}

model FacturaEliminada {
  id                Int              @id @default(autoincrement())
  facturaInternetId Int?
  periodo           String
  montoPago         Float
  fechaPagoEsperada DateTime
  clienteId         Int
  usuarioId         Int
  fechaEliminacion  DateTime         @default(now())
  motivo            String?
  facturaInternet   FacturaInternet? @relation(fields: [facturaInternetId], references: [id])
  usuario           Usuario          @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([facturaInternetId])
}

/// [08] Rutas de Cobro
model Ruta {
  id            Int               @id @default(autoincrement())
  nombreRuta    String
  cobradorId    Int?
  montoCobrado  Int               @default(0)
  estadoRuta    EstadoRuta        @default(ACTIVO)
  empresaId     Int
  observaciones String?
  actualizadoEn DateTime          @updatedAt
  creadoEn      DateTime          @default(now())
  cobros        CobroRuta[]       @relation("RutaToCobros")
  facturas      FacturaRuta[]
  cobrador      Usuario?          @relation(fields: [cobradorId], references: [id], onDelete: Cascade)
  empresa       Empresa           @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  turnos        RutaTurno[]
  clientes      ClienteInternet[] @relation("ClienteInternetToRuta")
}

model RutaTurno {
  id             Int             @id @default(autoincrement())
  rutaId         Int
  fecha          DateTime
  cobradorId     Int?
  estado         EstadoRutaTurno @default(ABIERTA)
  aperturaEn     DateTime        @default(now())
  cierreEn       DateTime?
  notas          String?
  totalAsignadas Int             @default(0)
  totalCobradas  Int             @default(0)
  sumaCobros     Float           @default(0)
  cobrador       Usuario?        @relation(fields: [cobradorId], references: [id])
  ruta           Ruta            @relation(fields: [rutaId], references: [id], onDelete: Cascade)

  @@unique([rutaId, fecha])
  @@index([estado])
  @@index([cobradorId])
}

model FacturaRuta {
  id            Int                   @id @default(autoincrement())
  rutaId        Int
  facturaId     Int
  asignadaEn    DateTime              @default(now())
  asignadaPorId Int?
  estado        EstadoAsignacionRuta  @default(ASIGNADA)
  motivo        String?
  cobradaEn     DateTime?
  cobradaPorId  Int?
  observaciones String?
  asignadaPor   Usuario?              @relation("AsignadorFacturaRuta", fields: [asignadaPorId], references: [id])
  cobradaPor    Usuario?              @relation("CobradorFacturaRuta", fields: [cobradaPorId], references: [id])
  factura       FacturaInternet       @relation(fields: [facturaId], references: [id], onDelete: Cascade)
  ruta          Ruta                  @relation(fields: [rutaId], references: [id], onDelete: Cascade)
  pagos         PagoFacturaInternet[]

  @@unique([rutaId, facturaId])
  @@index([facturaId, estado])
  @@index([rutaId, estado])
}

model CobroRuta {
  id            Int             @id @default(autoincrement())
  clienteId     Int
  rutaId        Int
  montoCobrado  Int
  estadoCobro   EstadoCobro
  fechaCobro    DateTime        @default(now())
  observaciones String?
  actualizadoEn DateTime        @updatedAt
  creadoEn      DateTime        @default(now())
  cliente       ClienteInternet @relation(fields: [clienteId], references: [id])
  ruta          Ruta            @relation("RutaToCobros", fields: [rutaId], references: [id])
}

/// [09] Soporte y Tickets
model TicketSoporte {
  id                     Int                    @id @default(autoincrement())
  // clienteId              Int
  clienteId Int?  // <--- Agrega el signo de interrogación
  empresaId              Int?
  tecnicoId              Int?
  creadoPorId            Int?
  estado                 EstadoTicketSoporte    @default(ABIERTA)
  prioridad              PrioridadTicketSoporte @default(MEDIA)
  titulo                 String?
  descripcion            String?
  fechaCierre            DateTime?
  fechaApertura          DateTime               @default(now())
  fechaAsignacion        DateTime?
  fechaInicioAtencion    DateTime?
  fechaResolucionTecnico DateTime?
  // FIJAR
  creadoEn     DateTime? @default(now())
  actualizadoEn DateTime @updatedAt @default(now())

  fijado                 Boolean                @default(false)
  // --- NUEVO: resumen / responsable cierre ---
  resumen                TicketResumen?         @relation("TicketResumenTicket")

  boleta            BoletaSoporte?
  SeguimientoTicket SeguimientoTicket[]
  etiquetas         TicketEtiqueta[]
  // cliente           ClienteInternet        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  cliente           ClienteInternet? @relation(fields: [clienteId], references: [id], onDelete: Cascade) 
  creadoPor         Usuario?               @relation("TicketCreador", fields: [creadoPorId], references: [id])
  empresa           Empresa?                @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  tecnico           Usuario?               @relation("TicketTecnico", fields: [tecnicoId], references: [id])
  asignaciones      TicketSoporteTecnico[]
  logsTiempo             TicketTimeLog[]
}

model TicketTimeLog {
  id        Int      @id @default(autoincrement())
  // Relación con el Ticket
  ticketId  Int
  ticket    TicketSoporte @relation(fields: [ticketId], references: [id])
  // Relación con el Usuario (Técnico)
  tecnicoId Int
  tecnico   Usuario @relation("LogTecnico", fields: [tecnicoId], references: [id])
  
  inicio          DateTime @default(now())
  fin             DateTime?
  duracionMinutos Int?
}


model BoletaSoporte {
  id            Int            @id @default(autoincrement())
  ticketId      Int?           @unique
  conforme      Boolean        @default(false)
  firmadoPor    String?
  observaciones String?
  fechaFirma    DateTime?
  generadoPorId Int?
  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt
  generadoPor   Usuario?       @relation(fields: [generadoPorId], references: [id])
  ticket        TicketSoporte? @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model EtiquetaTicket {
  id            Int              @id @default(autoincrement())
  nombre        String           @unique
  actualizadoEn DateTime?        @updatedAt
  creadoEn      DateTime?        @default(now())
  tickets       TicketEtiqueta[]
}

model TicketEtiqueta {
  id            Int            @id @default(autoincrement())
  ticketId      Int
  etiquetaId    Int
  actualizadoEn DateTime?      @updatedAt
  creadoEn      DateTime?      @default(now())
  etiqueta      EtiquetaTicket @relation(fields: [etiquetaId], references: [id], onDelete: Cascade)
  ticket        TicketSoporte  @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([ticketId, etiquetaId])
}

model SeguimientoTicket {
  id            Int           @id @default(autoincrement())
  ticketId      Int
  usuarioId     Int
  descripcion   String
  fechaRegistro DateTime      @default(now())
  ticket        TicketSoporte @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  usuario       Usuario       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @default(now()) @updatedAt
}

//PIVOTE TEC. ASIGNADOS Y RESUELTOS POR ->
model TicketSoporteTecnico {
  id            Int      @id @default(autoincrement())
  ticketId      Int
  tecnicoId     Int
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  // rol en la resolución
  esResponsable        Boolean   @default(false) // true si este técnico cuenta como "lo resolvió"
  resolvioEn           DateTime? // cuándo este técnico marcó como resuelto (si aplica)
  tiempoTecnicoMinutos Int? // tiempo que le asignas a este técnico en este ticket

  tecnico Usuario       @relation(fields: [tecnicoId], references: [id], onDelete: Cascade)
  ticket  TicketSoporte @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([ticketId, tecnicoId])
  @@index([tecnicoId])
}

model MetaTecnicoTicket {
  id               Int              @id @default(autoincrement())
  tecnicoId        Int
  fechaInicio      DateTime         @default(now())
  fechaFin         DateTime
  metaTickets      Int
  ticketsResueltos Int              @default(0)
  cumplida         Boolean          @default(false)
  fechaCumplida    DateTime?
  titulo           String?
  estado           EstadoMetaTicket
  actualizadoEn    DateTime         @updatedAt
  creadoEn         DateTime         @default(now())
  tecnico          Usuario          @relation("MetaTecnicoRelation", fields: [tecnicoId], references: [id], onDelete: Cascade)

  @@index([tecnicoId, fechaInicio, fechaFin])
}

model MetaTickets {
  id               Int               @id @default(autoincrement())
  tituloMetaTicket String
  fechaInicio      DateTime          @default(now())
  fechaFin         DateTime?
  ticketsMeta      Int
  ticketsAvance    Int               @default(0)
  estado           EstadoMetaTickets @default(ACTIVO)
  usuarioId        Int?
  cumplida         Boolean           @default(false)
  fechaCompletada  DateTime?
  usuario          Usuario?          @relation(fields: [usuarioId], references: [id])
}

// NUEVA TELEMETRÍA ---->
model TicketResumen {
  id         Int  @id @default(autoincrement())
  ticketId   Int  @unique
  solucionId Int?

  // Qué se hizo / cómo quedó
  resueltoComo  String? // texto libre: "Se rehizo acometida, se cambió ONT, etc."
  notasInternas String?

  // Reaperturas / intentos
  reabierto         Boolean @default(false)
  numeroReaperturas Int     @default(0)
  intentos          Int     @default(1) // intentos totales sobre el mismo ticket

  // Tiempos (en minutos) -> los calculas con las fechas del ticket y los guardas aquí
  tiempoTotalMinutos   Int? // desde apertura hasta cierre
  tiempoTecnicoMinutos Int? // desde inicio atención hasta resolución técnico

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  ticket   TicketSoporte   @relation("TicketResumenTicket", fields: [ticketId], references: [id], onDelete: Cascade)
  solucion SolucionTicket? @relation(fields: [solucionId], references: [id])

  @@index([solucionId])
}

//tabla de soluciones custom
model SolucionTicket {
  id            Int             @id @default(autoincrement())
  solucion      String          @unique // p.ej: "REDROPEO", "CAMBIO_IP", "RECONFIG_ROUTER"
  descripcion   String?
  tickets       TicketResumen[]
  isEliminado   Boolean         @default(false)
  creadoEn      DateTime        @default(now())
  actualizadoEn DateTime        @default(now()) @updatedAt
}

/// [10] Asistencia / RRHH
model Asistencia {
  id              Int       @id @default(autoincrement())
  usuarioId       Int
  fecha           DateTime
  horaEntrada     DateTime
  horaSalida      DateTime?
  minutosTarde    Int?
  trabajoCompleto Boolean   @default(false)
  creadoEn        DateTime? @default(now())
  actualizadoEn   DateTime  @updatedAt
  usuario         Usuario   @relation("UsuarioAsistencias", fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, fecha])
  @@index([usuarioId, fecha])
}

/// [11] Modelos de Prueba
model TestCategory {
  id       String @id @default(uuid())
  name     String
  products Test[]
}

model Test {
  id         String       @id @default(uuid())
  name       String
  categoryId String
  category   TestCategory @relation(fields: [categoryId], references: [id])
}

/// [12] Notificaciones
model Notificacion {
  id Int @id @default(autoincrement())
  empresaId Int? // noti pertenece a una empresa (o null si GLOBAL)
  empresa   Empresa? @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  // Contenido 
  titulo         String?
  mensaje        String
  categoria      CategoriaNotificacion @default(OTROS)
  subtipo        String? // ej: 'FACTURAS_GENERADAS', 'PAGO_REGISTRADO', 'TICKET_CREADO'
  severidad      SeveridadNotificacion @default(INFO)
  url            String?
  // Contexto de negocio
  referenciaTipo String? // 'TicketSoporte', 'FacturaInternet', 'ClienteInternet', etc.
  referenciaId   Int? // ID de la entidad referenciada
  route          String? // ej: '/tickets/123' o '/facturacion/internet?zona=1&periodo=202501'
  actionLabel    String? // ej: 'Ver detalle'

  // Emisor / auditoría
  remitenteId Int?
  remitente   Usuario? @relation("NotificacionRemitente", fields: [remitenteId], references: [id])

  audiencia AudienciaNotificacion @default(USUARIOS)

  fechaCreacion DateTime  @default(now())
  visibleDesde  DateTime?
  expiraEn      DateTime?
  programadaEn  DateTime? // si algún día quieres programar envíos diferidos

  // Estado por usuario
  destinatarios NotificacionUsuario[]

  @@index([empresaId, categoria, severidad, fechaCreacion])
  @@index([referenciaTipo, referenciaId])
  @@index([fechaCreacion])
}

model NotificacionUsuario {
  id             Int @id @default(autoincrement())
  usuarioId      Int
  notificacionId Int

  usuario      Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  notificacion Notificacion @relation(fields: [notificacionId], references: [id], onDelete: Cascade)

  // Estado por usuario
  leido       Boolean   @default(false)
  leidoEn     DateTime?
  eliminado   Boolean   @default(false) // oculto/dismiss
  eliminadoEn DateTime?

  recibidoEn  DateTime  @default(now())
  fijadoHasta DateTime? // si quieres poder pinear notis en la UI

  @@unique([usuarioId, notificacionId]) // evita duplicados
  @@index([usuarioId, eliminado, leido, recibidoEn])
}

/// [13] OLT
model Olt {
  id            Int     @id @default(autoincrement())
  nombre        String // Nombre amigable: "OLT TP-Link Jacaltenango"
  modelo        String? // "P1201-16"
  vendor        String? // "TP-Link"
  serie         String? // Device SN
  mgmtIp        String // IP de gestión
  mgmtVlan      Int? // VLAN de gestión si la usas
  telnetPort    Int     @default(23)
  snmpCommunity String? // solo lectura normalmente

  empresaId Int
  empresa   Empresa @relation(fields: [empresaId], references: [id])

  MikrotikRouter MikrotikRouter[]

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@unique([empresaId, nombre])
}

/// [14] MIKROTIK-ROUTER
model MikrotikRouter {
  id          Int     @id @default(autoincrement())
  nombre      String // "MKT Core Jacaltenango"
  host        String // IP o FQDN de gestión
  sshPort     Int     @default(22)
  usuario     String // usuario de automatización (la pass la manejas fuera)
  descripcion String?
  activo      Boolean @default(true)
  passwordEnc String? // contraseña encriptada base64

  empresaId Int
  empresa   Empresa @relation(fields: [empresaId], references: [id])

  // Opcional
  oltId Int?
  olt   Olt? @relation(fields: [oltId], references: [id])

  clientesInternet ClienteInternet[] // Clientes que cuelgan de este Mikrotik

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@unique([empresaId, nombre])
}

/// [X] Enumeraciones

enum CategoriaNotificacion {
  SISTEMA // cosas generales del sistema
  FACTURACION // facturas, pagos, periodos
  COBRANZA // cortes, avisos de morosidad, rutas
  SOPORTE // tickets de soporte
  RUTA_COBRO // eventos de rutas / cobradores
  CLIENTE // alta/baja de clientes, cambios de servicio
  BOT
  OTROS
}

enum SeveridadNotificacion {
  INFO
  EXITO
  ALERTA
  ERROR
  CRITICA
}

enum AudienciaNotificacion {
  USUARIOS // usuarios específicos (join table)
  ROL // usuarios por rol (igual termina en join por usuario)
  EMPRESA // todos los usuarios de la empresa
  GLOBAL // todo el sistema (multi-empresa)
}

enum OrigenPago {
  RUTA
  OFICINA
  TRANSFERENCIA
  EN_LINEA
}

enum EstadoAsignacionRuta {
  ASIGNADA
  EN_PROCESO
  COBRADA
  CANCELADA
  REASIGNADA
}

enum EstadoRutaTurno {
  ABIERTA
  EN_CURSO
  CERRADA
  ANULADA
}

enum TipoPlantilla {
  GENERACION_FACTURA
  RECORDATORIO_1
  RECORDATORIO_2
  AVISO_PAGO
  SUSPENSION
  CORTE
}

enum StateFacturaInternet {
  PENDIENTE
  PAGADA
  VENCIDA
  ANULADA
  PARCIAL
}

enum ResultadoRecordatorioPago {
  PENDIENTE
  PAGADO
  OTRO
}

enum EstadoCobro {
  COBRADO
  SIN_COBRAR
}

enum EstadoMetaTicket {
  CANCELADO
  ABIERTO
  FINALIZADO
  CERRADO
}

enum EstadoRuta {
  ACTIVO
  CERRADO
  CANCELADO
  EN_CURSO
  ASIGNADA
}

enum EstadoMetaTickets {
  ACTIVO
  CERRADO
  CANCELADO
}

enum EstadoCliente {
  ACTIVO
  SUSPENDIDO
  DESINSTALADO
  PENDIENTE_ACTIVO
  EN_INSTALACION
  PAGO_PENDIENTE // NO USAR
  ATRASADO // NO USAR
  MOROSO // NO USAR
}

enum EstadoCobranzaCliente {
  AL_DIA
  PAGO_PENDIENTE
  ATRASADO
  MOROSO
}

enum EstadoServicio {
  ACTIVO
  INACTIVO
}

enum EstadoFacturaInternet {
  PENDIENTE
  PAGADA
  ATRASADA
  CANCELADA
}

enum EstadoTicketSoporte {
  NUEVO
  ABIERTA
  EN_PROCESO
  PENDIENTE
  PENDIENTE_CLIENTE
  PENDIENTE_TECNICO
  RESUELTA
  CANCELADA
  ARCHIVADA
  CERRADO
  PENDIENTE_REVISION
}

enum TipoFactura {
  INTERNET
  SERVICIO_ADICIONAL
}

enum PrioridadTicketSoporte {
  BAJA
  MEDIA
  ALTA
  URGENTE
}

enum RolUsuario {
  TECNICO
  OFICINA
  ADMIN
  SUPER_ADMIN
  COBRADOR
}

enum EstadoClienteServicio {
  ACTIVO
  SUSPENDIDO
  CANCELADO
}

enum MetodoPago {
  EFECTIVO
  TARJETA
  TRANSFERENCIA
  PAYPAL
}

enum EstadoFactura {
  PENDIENTE
  PAGADA
  ATRASADA
  CANCELADA
}

enum MetodoPagoFacturaInternet {
  EFECTIVO
  TARJETA
  DEPOSITO
  PAYPAL
  PENDIENTE
  OTRO
}

enum TipoMedia {
  IMAGEN
  VIDEO
  DOCUMENTO
  AUDIO
  OTRO
}

enum EstadoMedia {
  PENDIENTE
  PROCESANDO
  LISTO
  FALLIDO
}

enum ProveedorStorage {
  DO_SPACES
  AWS_S3
  GCS
  AZURE
  LOCAL
}

enum CategoriaMedia {
  CLIENTE_GENERAL
  CLIENTE_CONTRATO
  CLIENTE_INSTALACION
  SOPORTE_TICKET
  OTRO
}

enum EstadoServicioMikrotik {
  SIN_MIKROTIK
  ACTIVO
  SUSPENDIDO
  PENDIENTE_APLICAR
  ERROR
}